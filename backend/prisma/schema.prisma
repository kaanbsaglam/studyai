// Prisma Schema for StudyAI
// Run `npx prisma migrate dev` to apply changes
// Run `npx prisma generate` to regenerate the client
// Run `npx prisma studio` to open the database GUI

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Enums
// ============================================
enum UserRole {
  USER
  ADMIN
}

enum UserTier {
  FREE
  PREMIUM
}

enum DocumentStatus {
  PENDING    // Just uploaded, not processed yet
  PROCESSING // Currently being chunked/embedded
  READY      // Successfully processed, ready for RAG
  FAILED     // Processing failed
}

// ============================================
// User & Authentication
// ============================================
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String?
  role         UserRole @default(USER)
  tier         UserTier @default(FREE)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  classrooms       Classroom[]
  documents        Document[]
  dailyUsage       DailyUsage[]
  flashcardSets    FlashcardSet[]
  quizSets         QuizSet[]
  summaries        Summary[]
  notes            Note[]
  studySessions    StudySession[]
  pomodoroSettings PomodoroSettings?

  @@map("users")
}

// ============================================
// Daily Usage Tracking (for tier limits)
// ============================================
model DailyUsage {
  id            String   @id @default(uuid())
  date          DateTime @db.Date // Just the date, no time
  tokensUsed    Int      @default(0) @map("tokens_used") // Total tokens (input + output)

  // Relations
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // One record per user per day
  @@unique([userId, date])
  @@map("daily_usage")
}

// ============================================
// Organization: Classrooms
// ============================================
// A classroom represents a course/subject that contains documents
model Classroom {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  userId        String         @map("user_id")
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents     Document[]
  flashcardSets FlashcardSet[]
  quizSets      QuizSet[]
  summaries     Summary[]
  notes         Note[]
  studySessions StudySession[]

  @@map("classrooms")
}

// ============================================
// Documents
// ============================================
model Document {
  id          String         @id @default(uuid())
  filename    String
  originalName String        @map("original_name")
  mimeType    String         @map("mime_type")
  size        Int            // File size in bytes
  s3Key       String         @map("s3_key")  // Path in S3
  status      DocumentStatus @default(PENDING)
  errorMessage String?       @map("error_message") // If status is FAILED
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  // Relations
  userId        String         @map("user_id")
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  classroomId   String         @map("classroom_id")
  classroom     Classroom      @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  chunks        DocumentChunk[]
  flashcardSets FlashcardSet[]
  notes         Note[]
  studySessions StudySession[]

  @@map("documents")
}

// ============================================
// Document Chunks (for RAG reference)
// ============================================
// We store chunk metadata here so we can show source citations
// The actual vectors are in Pinecone
model DocumentChunk {
  id          String   @id @default(uuid())
  chunkIndex  Int      @map("chunk_index")
  content     String   // The text content of this chunk
  pineconeId  String   @map("pinecone_id") // ID in Pinecone for reference
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  documentId String   @map("document_id")
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("document_chunks")
}

// ============================================
// Study Aids: Flashcards
// ============================================
model FlashcardSet {
  id          String   @id @default(uuid())
  title       String
  focusTopic  String?  @map("focus_topic") // Optional topic filter used during generation
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  classroomId String       @map("classroom_id")
  classroom   Classroom    @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  userId      String       @map("user_id")
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  documentId  String?      @map("document_id") // Optional - if set, was generated from this specific document
  document    Document?    @relation(fields: [documentId], references: [id], onDelete: SetNull)
  cards       Flashcard[]

  @@map("flashcard_sets")
}

model Flashcard {
  id       String @id @default(uuid())
  front    String // Question side
  back     String // Answer side
  position Int    // Order within the set

  // Relations
  flashcardSetId String       @map("flashcard_set_id")
  flashcardSet   FlashcardSet @relation(fields: [flashcardSetId], references: [id], onDelete: Cascade)

  @@map("flashcards")
}

// ============================================
// Study Aids: Quizzes
// ============================================
model QuizSet {
  id         String   @id @default(uuid())
  title      String
  focusTopic String?  @map("focus_topic") // Optional topic filter used during generation
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  classroomId String        @map("classroom_id")
  classroom   Classroom     @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  userId      String        @map("user_id")
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  questions   QuizQuestion[]
  attempts    QuizAttempt[]

  @@map("quiz_sets")
}

model QuizAttempt {
  id           String   @id @default(uuid())
  score        Int      // Number of correct answers
  totalQuestions Int    @map("total_questions") // Total questions in quiz
  completedAt  DateTime @default(now()) @map("completed_at")

  // Relations
  quizSetId String  @map("quiz_set_id")
  quizSet   QuizSet @relation(fields: [quizSetId], references: [id], onDelete: Cascade)

  @@map("quiz_attempts")
}

model QuizQuestion {
  id            String   @id @default(uuid())
  question      String   // The question text
  correctAnswer String   @map("correct_answer") // The correct answer
  wrongAnswers  String[] @map("wrong_answers") // Array of 3 wrong answers (distractors)
  position      Int      // Order within the set

  // Relations
  quizSetId String  @map("quiz_set_id")
  quizSet   QuizSet @relation(fields: [quizSetId], references: [id], onDelete: Cascade)

  @@map("quiz_questions")
}

// ============================================
// Study Aids: Summaries
// ============================================
model Summary {
  id         String   @id @default(uuid())
  title      String
  focusTopic String?  @map("focus_topic") // Optional topic filter used during generation
  content    String   // The generated summary text
  length     String   // short, medium, long
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  classroomId String    @map("classroom_id")
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("summaries")
}

// ============================================
// Notes (User-written)
// ============================================
model Note {
  id        String   @id @default(uuid())
  title     String
  content   String   @db.Text // Markdown content
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  classroomId String    @map("classroom_id")
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  documentId  String?   @map("document_id") // Optional link to source document
  document    Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  @@map("notes")
}

// ============================================
// Study Time Tracking
// ============================================
enum ActivityType {
  DOCUMENT
  CHAT
  FLASHCARDS
  QUIZ
  SUMMARY
  NOTES
}

model StudySession {
  id              String       @id @default(uuid())
  startedAt       DateTime     @map("started_at")
  endedAt         DateTime?    @map("ended_at")
  durationSeconds Int          @default(0) @map("duration_seconds")
  activityType    ActivityType @default(DOCUMENT) @map("activity_type")
  classroomName   String       @map("classroom_name") // Cached for when classroom is deleted
  documentName    String?      @map("document_name")  // Cached for when document is deleted

  // Relations
  userId      String     @map("user_id")
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  classroomId String?    @map("classroom_id")
  classroom   Classroom? @relation(fields: [classroomId], references: [id], onDelete: SetNull)
  documentId  String?    @map("document_id")
  document    Document?  @relation(fields: [documentId], references: [id], onDelete: SetNull)

  @@index([userId, startedAt])
  @@index([classroomId, startedAt])
  @@map("study_sessions")
}

// ============================================
// Pomodoro Timer Settings
// ============================================
model PomodoroSettings {
  id                 String  @id @default(uuid())
  focusDuration      Int     @default(25) @map("focus_duration")
  shortBreakDuration Int     @default(5) @map("short_break_duration")
  longBreakDuration  Int     @default(15) @map("long_break_duration")
  sessionsBeforeLong Int     @default(4) @map("sessions_before_long")
  soundEnabled       Boolean @default(true) @map("sound_enabled")
  autoStartBreaks    Boolean @default(false) @map("auto_start_breaks")

  // Relations
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("pomodoro_settings")
}
